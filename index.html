<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App UPK178 - Rastreo en Vivo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: sans-serif; margin: 0; background: #1a1a1a; color: white; overflow: hidden; }
        /* Ajuste para que el mapa no se vea negro */
        #map { height: 65vh; width: 100%; background: #222; }
        .panel { padding: 20px; text-align: center; background: #222; border-top: 3px solid #ff9800; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-green { background: #28a745; color: white; }
        .btn-red { background: #dc3545; color: white; display: none; }
        .vibras-logo { color: #ff9800; font-weight: bold; font-style: italic; margin-top: 10px; }
        .info { font-size: 13px; margin-bottom: 10px; color: #ccc; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="info">üöö UPK 178 | Harold Augusto</div>
    <button id="btnStart" class="btn btn-green" onclick="iniciarServicio()">‚ñ∂Ô∏è INICIAR RASTREO (CONDUCTOR)</button>
    <button id="btnStop" class="btn btn-red" onclick="detenerServicio()">‚èπÔ∏è DETENER RASTREO</button>
    <div class="vibras-logo">‚ú® Vibras Positivas ‚ú®</div>
</div>

<script>
    // Configuraci√≥n Firebase (Harold Augusto)
    const firebaseConfig = {
        apiKey: "AIzaSyCTdSrjNaXauHAkWE0HLBJOcgBaEh5E6Gw",
        authDomain: "upk178-d8cbd.firebaseapp.com",
        databaseURL: "https://upk178-d8cbd-default-rtdb.firebaseio.com",
        projectId: "upk178-d8cbd",
        storageBucket: "upk178-d8cbd.firebasestorage.app",
        messagingSenderId: "406972511555",
        appId: "1:406972511555:web:90828ea0fe17fe332a2bf6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('monitoreo_upk178');

    // Inicializar Mapa (Caucasia)
    var map = L.map('map').setView([7.9789, -75.1991], 15);
    
    // Capa de mapa (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var marker = L.marker([7.9789, -75.1991]).addTo(map);
    let watchID = null;

    function iniciarServicio() {
        if ("geolocation" in navigator) {
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';

            watchID = navigator.geolocation.watchPosition(function(pos) {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                db.set({ lat, lng, hora: new Date().toLocaleTimeString() });
            }, (err) => alert("Activa el GPS de tu celular"), { enableHighAccuracy: true });
        }
    }

    function detenerServicio() {
        navigator.geolocation.clearWatch(watchID);
        document.getElementById('btnStart').style.display = 'block';
        document.getElementById('btnStop').style.display = 'none';
    }

    // ESCUCHAR EN TIEMPO REAL
    db.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            marker.setLatLng([data.lat, data.lng]);
            map.panTo([data.lat, data.lng]);
        }
    });

    // Forzar el redimensionamiento para evitar cuadros negros
    setTimeout(() => { map.invalidateSize(); }, 500);
</script>
</body>
</html>
